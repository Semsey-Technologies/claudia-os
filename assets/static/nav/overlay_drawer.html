<!DOCTYPE html>
<html>
<head>
    <style>
        body { margin: 0; padding: 0; background: transparent; font-family: monospace; overflow: hidden; }

        #drawer-container {
            width: 100vw; height: 100vh;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            display: flex; flex-direction: column;
            padding: 40px 30px 120px 30px;
            box-sizing: border-box;
        }

        #app-search {
            width: 100%; padding: 15px;
            background: rgba(0,0,0,0.5); border: 1px solid #00FFCC;
            color: #00FFCC; font-size: 18px; margin-bottom: 20px;
            border-radius: 8px;
        }

        #app-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;
            overflow-y: auto; /* Enables scrolling */
            flex-grow: 1;
        }

        .app-item { display: flex; flex-direction: column; align-items: center; text-align: center; }
        .app-item:active { transform: scale(0.95); opacity: 0.8; }

        .app-icon { width: 56px; height: 56px; margin-bottom: 8px; }
        .app-label { color: #fff; font-size: 11px; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        #loading-indicator {
            grid-column: span 4; text-align: center; color: #00FFCC; padding: 20px;
            display: none;
        }
    </style>
</head>
<body>
<div id="drawer-container">
    <input type="text" id="app-search" placeholder="SEARCH SYSTEM..." onkeyup="filterApps()" />
    <div id="app-grid">
        <div id="loading-indicator">LOADING DATA...</div>
    </div>
</div>

<script>
    let allAppsCache = []; // Stores ALL loaded apps
    let currentOffset = 0;
    let pageSize = 24;     // Load 24 at a time (nice multiple of 4 columns)
    let isLoading = false;
    let isEndOfList = false;

    // Start loading when page is ready
    loadMoreApps();

    // SCROLL LISTENER (Infinite Scroll)
    const grid = document.getElementById('app-grid');
    grid.addEventListener('scroll', () => {
        // If scrolled to bottom (within 100px)
        if (grid.scrollTop + grid.clientHeight >= grid.scrollHeight - 100) {
            loadMoreApps();
        }
    });

    function loadMoreApps() {
        if (isLoading || isEndOfList) return;
        isLoading = true;
        document.getElementById('loading-indicator').style.display = 'block';

        setTimeout(() => {
            try {
                if (typeof AndroidDrawer !== 'undefined') {
                    // Ask Kotlin for the next chunk
                    const jsonStr = AndroidDrawer.getAppChunk(currentOffset, pageSize);
                    const newApps = JSON.parse(jsonStr);

                    if (newApps.length === 0) {
                        isEndOfList = true; // Stop asking if empty
                        document.getElementById('loading-indicator').style.display = 'none';
                    } else {
                        // Add to cache
                        allAppsCache = allAppsCache.concat(newApps);
                        currentOffset += newApps.length;

                        // Render the new batch
                        appendAppsToGrid(newApps);
                    }
                }
            } catch (e) { console.error(e); }

            isLoading = false;
            document.getElementById('loading-indicator').style.display = 'none';
        }, 50); // Small delay to let UI breathe
    }

    function appendAppsToGrid(apps) {
        const grid = document.getElementById('app-grid');
        const loader = document.getElementById('loading-indicator');

        apps.forEach(app => {
            const item = document.createElement('div');
            item.className = 'app-item';
            item.onclick = () => { AndroidDrawer.launchApp(app.package); };

            item.innerHTML = `
                <img class="app-icon" src="${app.icon}" loading="lazy" />
                <span class="app-label">${app.label}</span>
            `;
            // Insert before the loader
            grid.insertBefore(item, loader);
        });
    }

    function filterApps() {
        const query = document.getElementById('app-search').value.toLowerCase();
        const grid = document.getElementById('app-grid');

        // Clear Grid visually (but keep loader)
        grid.innerHTML = '<div id="loading-indicator">LOADING DATA...</div>';

        // Filter our LOCAL cache
        // Note: Search only works on apps we have loaded so far
        const filtered = allAppsCache.filter(app => app.label.toLowerCase().includes(query));

        appendAppsToGrid(filtered);
    }

    // Close on background click
    document.getElementById('drawer-container').onclick = function(e) {
        if(e.target.id === 'drawer-container') AndroidDrawer.closeDrawer();
    }
</script>
</body>
</html>